<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="shortcut icon" type="image/x-icon" href="http://104.236.159.193:8850/images/logoamigoinvesa.png"/>
  <title>
    Mapa Blancos Biologicos
  </title>

  <!-- Fonts and icons -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <!-- Nucleo Icons -->
  <link href="../css/nucleo-icons.css" rel="stylesheet" />
  <link href="../css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <link href="/css/nucleo-svg.css" rel="stylesheet" />
  <!-- CSS Files -->
  <link id="pagestyle" href="/css/soft-ui-dashboard.css?v=1.0.3" rel="stylesheet" />
  <!-- Tag inout css -->
  <link id="pagestyle" href="/css/bootstrap-tagsinput.css" rel="stylesheet" />
  

  <style>
    .choices__list{
      z-index: 3000;
    }
    .choices__item{
      font-size: 12px !important; 
    }
    .choices__item{
      /* opacity: 0 !important; */
    }
  </style>
</head>

<body class="g-sidenav-show bg-gray-100">

  <!-- Menu -->
  <%- include('./partials/menu.ejs') %>

  <main class="main-content max-height-vh-100 h-100">

    <!-- Navbar -->
    <%- include('./partials/head.ejs') %>

    <!-- Cotent -->
    <div class="p-4 m-4">

      <div class="d-flex justify-content-between align-items-center my-2">
        <h6 class="ms-2">Geolocalozacion Blancos Biologicos</h6>

        <div class="d-flex gap-2">
          <div style="width: 250px;">
            <label for="">Buscar departamento</label>
            <select name="" id="selectDpto"></select>
          </div>
          <div style="width: 250px;">
            <label for="">Buscar Municipio</label>
            <select name="" id="selectCity"></select>
          </div>
        </div>
      </div>

      <div class="d-flex  gap-3 mb-3">

        <div class="card" style="width: 32%; position: relative;">
          <div class=" h-100">
            <div class="card-body p-3 d-flex justify-content-center align-items-center flex-column" style="cursor: pointer" >
              <div class="text-center">
                <h2 style="color: #4caf50;"><span id="enfermedadesCount"></span></h2>
                <h4 style="text-transform: capitalize;">Enfermedades</h4> 
              </div> 

              <div style="width:250px;">
                <label for="">Buscar Enfermedad</label>
                <select name="" id="selecEnfermedad"></select>
              </div>

            </div>
          </div>
          <div class="form-check" style="position: absolute; right: 5%; top: 5%;">
            <input class="form-check-input chk_g" type="checkbox" value="Enfermedades" id="checkboxEnfermedades" checked="">
          </div>
        </div>

        <div class="card" style="width: 32%; position: relative;">
          <div class=" h-100">
            <div class="card-body p-3 d-flex justify-content-center align-items-center flex-column" style="cursor: pointer" >
              <div class="text-center">
                <h2 style="color: #FA5622;"><span id="malezasCount"></span></h2>
                <h4 style="text-transform: capitalize;">Malezas</h4> 
              </div> 
              <div style="width: 250px;">
                <label for="">Buscar Maleza</label>
                <select name="" id="selecMaleza"></select>
              </div>
            </div>
          </div>

          <div class="form-check" style="position: absolute; right: 5%; top: 5%;">
            <input class="form-check-input chk_g" type="checkbox" value="Malezas" id="checkboxMalezas" checked="">
          </div>
        </div>

        <div class="card" style="width: 32%; position: relative;">
          <div class=" h-100"><s></s>
            <div class="card-body p-3 d-flex justify-content-center align-items-center flex-column" style="cursor: pointer" >
              <div class="text-center">
                <h2 style="color: #6639B6;"><span id="plagasCount"></span></h2>
                <h4 style="text-transform: capitalize;">plagas</h4> 
              </div> 
              <div style="width: 250px;">
                <label for="">Buscar Plaga</label>
                <select name="" id="selectPlaga"></select>
              </div>
            </div>
          </div>

          <div class="form-check" style="position: absolute; right: 5%; top: 5%;">
            <input class="form-check-input chk_g" type="checkbox" value="Plagas" id="checkboxPlagas" checked="">
          </div>
        </div>
      </div>

      <div id="badgesContainer" class="w-100 p-1 mb-3" style="min-height: auto">
          <!-- <span class="badge bg-gradient-dark" style="position: relative;"> Antioquia</span> -->
      </div>

      <div>
        <div id="geolocalizacion_bb" style="width: 100%; height: 600px; position: relative; overflow: hidden;">
        </div>
      </div>

    </div>  
      
  </main>

  <!--   Core JS Files   -->
  <script src="../js/core/popper.min.js"></script>
  <script src="../js/core/bootstrap.min.js"></script>
  <script src="../js/plugins/perfect-scrollbar.min.js"></script>
  <script src="../js/plugins/smooth-scrollbar.min.js"></script>
  <script src="../js/plugins/choices.min.js"></script>
  <!-- Kanban scripts -->
  <script src="../js/plugins/dragula/dragula.min.js"></script>
  <script src="../js/plugins/jkanban/jkanban.js"></script>
  <!-- Jquery -->
  <script src="../js/jquery.js"></script>
  <script src="../js/jquery-ui.min.js"></script>
  <!-- Underscore -->
  <script src="../js/underscore-min.js"></script>
  <!-- Script Plantilla -->
  <script src="../js/soft-ui-dashboard.min.js?v=1.0.3"></script>
  <!-- Datatable -->
  <script src="../js/plugins/datatables.js"></script>

  <!-- Google Maps Api -->
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyC79kryTLJgVPH_kuwrSLAuMCA3-A9tP3M"></script>
  <!-- Taginput -->
  <script type="text/javascript" src="../js/plugins/bootstrap-tagsinput.min.js"></script>
  

  <script>  
    const handleJSON = (s) => {
      if (s == null && s == "") { return }
      // Remove special characters
      s = s.replace(/\\n/g, "\\n")  
           .replace(/\\'/g, "\\'")
           .replace(/\\"/g, '\\"')
           .replace(/\\&/g, "\\&")
           .replace(/\\r/g, "\\r")
           .replace(/\\t/g, "\\t")
           .replace(/\\b/g, "\\b")
           .replace(/\\f/g, "\\f")
           .replace(/[\u0000-\u0019]+/g,"")
           .replace(/\n/g, "\\n");

      // Remove New Lines
      return JSON.parse(s)
    }

    var datos = '<%- data %>';
    datos = handleJSON(datos)
    datos = datos.data;
    console.log(datos)

    var departamentos = '<%- dptos %>';
    departamentos = handleJSON(departamentos)
    departamentos = departamentos.data;
    console.log(departamentos);

    // Codigo Anterior
    var map;
    var drawMap = function() {
      var styles = [{
        "stylers": [
          { "saturation": -100 },
          { "gamma": 1.07 }
        ]}
      ];
      // End Styles
      var mapa = new google.maps.LatLng(5.2445497,-72.4879592);
      var styledMap = new google.maps.StyledMapType(styles,{name: "Styled Map"});
      var mapOptions = {
        zoom: 6,
        center: mapa,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        mapTypeControlOptions: {
          mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'map_style']
        }
      }

      map = new google.maps.Map($("#geolocalizacion_bb")[0], mapOptions);
      map.mapTypes.set('map_style', styledMap);
      map.setMapTypeId('map_style');

      var currentPlace = null;
      var info = $('#placeDetails');
      infowindow = new google.maps.InfoWindow();
    };

    var showMarkers = function(markersList) {
      let data;
      if (markersList) {data = markersList} 
      else {data = currentMarkers}
      if (currentMarkers.length == 0) {
        data = datos.datos; 
        let checkboxes = $(".chk_g");
        for (let i = 0; i < checkboxes.length; i++) {
          $(checkboxes[i]).prop('checked', true);
        }
      }
    
      markers = [];
      _.each(data, function(d,i){
        var place = d;
        var icon = "http://api.pedbox.co:8850/images/marker1.png";
        if (place.id_catalogo == 3) {
          icon = "http://api.pedbox.co:8850/images/marker2.png";
        } else if (place.id_catalogo == 4) {
          icon = "http://api.pedbox.co:8850/images/marker3.png";
        }
        marker = new google.maps.Marker({
          position: new google.maps.LatLng(place.latitud, place.longitud),
          map: map,
          icon: icon
        });
        markers.push(marker);
        bindInfoWindow(marker, map, place.titulo);
      });
    };

    var clearMarkers = function() {
      for (var i = 0; i < markers.length; i++ ) {
        markers[i].setMap(null);
      }
      markers = [];
    };

    var bindInfoWindow = function(marker, map, description) {
      google.maps.event.addListener(marker, 'click', function() {
        infowindow.setContent(description);
        infowindow.open(map, marker);
      });
    };

    // Codigo Nuevo
    let printListBB = (data) => {
      let enfermedades = [],
          plagas = [],
          malezas = [];

      for (let i = 0; i < data.length; i++) {
        if (data[i].catalogo == "Enfermedades" && !enfermedades.includes(data[i].titulo)) {
          enfermedades.push(data[i].titulo)
        }
        if (data[i].catalogo == "Malezas" && !malezas.includes(data[i].titulo)) {
          malezas.push(data[i].titulo)
        }
        if (data[i].catalogo == "Plagas" && !plagas.includes(data[i].titulo)) {
          plagas.push(data[i].titulo)
        }
      }

      for (let i = 0; i < enfermedades.length; i++) {
        let element = `
          <option>${enfermedades[i]}</option>
        `;
        $("#selecEnfermedad").append(element)
      }
      $("#selecEnfermedad").append(`<option value="" selected disabled hidden>...</option>`)
      const enfermedadList = new Choices($('#selecEnfermedad')[0]);

      for (let i = 0; i < malezas.length; i++) {
        let element = `
          <option>${malezas[i]}</option>
        `;
        $("#selecMaleza").append(element)
      }
      $("#selecMaleza").append(`<option value="" selected disabled hidden>...</option>`)
      const malezaList = new Choices($('#selecMaleza')[0]);
      

      for (let i = 0; i < plagas.length; i++) {
        let element = `
          <option>${plagas[i]}</option>
        `;
        $("#selectPlaga").append(element)
      }
      $("#selectPlaga").append(`<option value="" selected disabled hidden>...</option>`)
      const plagaList = new Choices($('#selectPlaga')[0]);
    }

    let printDepartamentos = (data) => {
      for (let i = 0; i < data.length; i++) {
        let element = `
          <option ${data[i].id}>${data[i].descripcion}</option>
        `;
        $("#selectDpto").append(element)
      }
      $("#selectDpto").append(`<option value="-1" selected>...</option>`)
      var dptosList = new Choices($('#selectDpto')[0]);
    };

    let printCiudades = (data) => {
      let ciudades = []
      for (let i = 0; i < data.length; i++) {
        ciudades = ciudades.concat(data[i].ciudades)
      };
      for (let i = 0; i < ciudades.length; i++) {
        let element = `
          <option ${ciudades[i].id}>${ciudades[i].ciudad}</option>
        `;
        $("#selectCity").append(element)
      }
      $("#selectCity").append(`<option value="" selected disabled hidden>...</option>`)
      const cityList = new Choices($('#selectCity')[0]);
    };

    var fitlerByTitle = function(title){
      clearMarkers();
      $('.chk_g').prop('checked', false);
      var r = _.groupBy(datos.datos, function(obj) { return obj.titulo.toLowerCase() == title.toLowerCase() }).true;
      currentMarkers = currentMarkers.concat(r)
      showMarkers();
    };
    $(document).on("change", "#selecEnfermedad, #selecMaleza, #selectPlaga", function () {
      printBadges($(this).text())
      fitlerByTitle($(this).text());
    })

    var fitlerByUbicacion = function(ubicacion) {
      clearMarkers();
      $('.chk_g').prop('checked', false);
      var r = _.groupBy(datos.datos, function(obj) { return obj.ciudad.toLowerCase() == ubicacion.toLowerCase() }).true;
      currentMarkers = currentMarkers.concat(r)
      showMarkers();
    };
    $(document).on("change", "#selectCity", function () {
      printBadges($(this).text())
      fitlerByUbicacion($(this).text());
    })

    var filterByDepartamento = function(depto) {
      clearMarkers();
      $('.chk_g').prop('checked', false);
      var r = _.groupBy(datos.datos, function(obj) { return obj.departamento.toLowerCase() == depto.toLowerCase() }).true;
      currentMarkers = currentMarkers.concat(r)
      showMarkers();
    };
    $(document).on("change", "#selectDpto", function () {
      printBadges($(this).text())
      filterByDepartamento($(this).text());
    })

    const printBadges = (data) => {
      if ($("#badgesContainer span").length == 0) {currentMarkers = []; }
      let element = `
        <span class="badge bg-gradient-dark badgeEvent" style="cursor: pointer">${data}</span>
      `;
      $("#badgesContainer").append(element)
    }
    $(document).on("click", ".badgeEvent", function () {
      let data = $(this).text();
      $(this).remove()
    
      currentMarkers = currentMarkers.filter( el => el.titulo.toLowerCase() !== data.toLowerCase() );
      currentMarkers = currentMarkers.filter( el => el.ciudad.toLowerCase() !== data.toLowerCase() );
      currentMarkers = currentMarkers.filter( el => el.departamento.toLowerCase() !== data.toLowerCase() );
      clearMarkers();
      showMarkers();
    })

    const updateCheboxState = () => {
      $("#badgesContainer").html("")
      let checkboxes = $(".chk_g");
      currentMarkers = datos.datos;
      for (let i = 0; i < checkboxes.length; i++) {
        if (!$(checkboxes[i]).is(":checked")) {
          currentMarkers = currentMarkers.filter( el => el.catalogo.toLowerCase() !== $(checkboxes[i]).val().toLowerCase() );
        }
      }
      clearMarkers();
      showMarkers();
    }
    $('.chk_g').change(function() {
      updateCheboxState()
    });

    const printContador = (data) => {
      let enfermedades = 0;
      let malezas = 0;
      let plagas = 0;
      for (let i = 0; i < data.length; i++) {
        if (data[i].catalogo == "Malezas") {malezas += 1}
        if (data[i].catalogo == "Enfermedades") {enfermedades += 1}
        if (data[i].catalogo == "Plagas") {plagas += 1; $('.chk_g').prop('checked', true)}
      }

      $("#enfermedadesCount").text(enfermedades)
      $("#malezasCount").text(malezas)
      $("#plagasCount").text(plagas)
    };


    var currentMarkers = [];
    $(document).ready(function () {
      drawMap();
      showMarkers(datos.datos);
      printContador(datos.datos);
      printListBB(datos.datos);
      printDepartamentos(departamentos.deptociudad);
      printCiudades(departamentos.deptociudad);
    })
  </script>

</body>
</html>