<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="shortcut icon" type="image/x-icon" href="http://104.236.159.193:8850/images/logoamigoinvesa.png"/>
  <title>
    Mapa Blancos Biologicos
  </title>

  <!-- Fonts and icons -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <!-- Nucleo Icons -->
  <link href="../css/nucleo-icons.css" rel="stylesheet" />
  <link href="../css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <link href="/css/nucleo-svg.css" rel="stylesheet" />
  <!-- CSS Files -->
  <link id="pagestyle" href="/css/soft-ui-dashboard.css?v=1.0.3" rel="stylesheet" />

  <style>

  </style>
</head>

<body class="g-sidenav-show bg-gray-100">

  <!-- Menu -->
  <%- include('./partials/menu.ejs') %>

  <main class="main-content max-height-vh-100 h-100">

    <!-- Navbar -->
    <%- include('./partials/head.ejs') %>

    <!-- Cotent -->
    <div class="p-4 m-4">

      <h6 class="ms-2">Mapa Blancos Biologicos</h6>

      <div class="d-flex  gap-3 mb-3">
        <div class="card" style="width: 32%;">
          <div class=" h-100">
            <div class="card-body p-3 d-flex justify-content-center align-items-center flex-column" style="cursor: pointer" >
              <div class="text-center">
                <h2 style="color: #4caf50;"><span id="enfermedadesCount"></span></h2>
                <h4 style="text-transform: capitalize;">Enfermedades</h4> 
              </div> 
              <div style="position: relative;">
                <i class="fas fa-search" style="position: absolute; top: 30%; left: 10px"></i>
                <input type="text" class="form-control" placeholder="Buscar Enfermedad" style="padding-left: 35px; border: none; border-bottom: solid 1px lightgray;">
              </div>
            </div>
          </div>
        </div>
        <div class="card" style="width: 32%;">
          <div class=" h-100">
            <div class="card-body p-3 d-flex justify-content-center align-items-center flex-column" style="cursor: pointer" >
              <div class="text-center">
                <h2 style="color: #FA5622;"><span id="malezasCount"></span></h2>
                <h4 style="text-transform: capitalize;">Malezas</h4> 
              </div> 
              <div style="position: relative;">
                <i class="fas fa-search" style="position: absolute; top: 30%; left: 10px"></i>
                <input type="text" class="form-control" placeholder="Buscar Maleza" style="padding-left: 35px; border: none; border-bottom: solid 1px lightgray;" >
              </div>
            </div>
          </div>
        </div>
        <div class="card" style="width: 32%;">
          <div class=" h-100"><s></s>
            <div class="card-body p-3 d-flex justify-content-center align-items-center flex-column" style="cursor: pointer" >
              <div class="text-center">
                <h2 style="color: #6639B6;"><span id="plagasCount"></span></h2>
                <h4 style="text-transform: capitalize;">plagas</h4> 
              </div> 
              <div style="position: relative;">
                <i class="fas fa-search" style="position: absolute; top: 30%; left: 10px"></i>
                <input type="text" class="form-control" placeholder="Buscar Plaga" style="padding-left: 35px; border: none; border-bottom: solid 1px lightgray;">
              </div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <div id="geolocalizacion_bb" style="width: 100%; height: 600px; position: relative; overflow: hidden;">
        </div>
      </div>

    </div>  
      
  </main>

  <!--   Core JS Files   -->
  <script src="../js/core/popper.min.js"></script>
  <script src="../js/core/bootstrap.min.js"></script>
  <script src="../js/plugins/perfect-scrollbar.min.js"></script>
  <script src="../js/plugins/smooth-scrollbar.min.js"></script>
  <script src="../js/plugins/choices.min.js"></script>
  <!-- Kanban scripts -->
  <script src="../js/plugins/dragula/dragula.min.js"></script>
  <script src="../js/plugins/jkanban/jkanban.js"></script>
  <!-- Jquery -->
  <script src="../js/jquery.js"></script>
  <script src="../js/jquery-ui.min.js"></script>
  <!-- Underscore -->
  <script src="../js/underscore-min.js"></script>
  <!-- Script Plantilla -->
  <script src="../js/soft-ui-dashboard.min.js?v=1.0.3"></script>
  <!-- Datatable -->
  <script src="../js/plugins/datatables.js"></script>

  <!-- Google Maps Api -->
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyC79kryTLJgVPH_kuwrSLAuMCA3-A9tP3M"></script>



  <script>  
    // http://api.pedbox.co:8850/images/marker2.png
    var map;

    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    const handleJSON = (s) => {
      if (s == null && s == "") { return }
      // Remove special characters
      s = s.replace(/\\n/g, "\\n")  
           .replace(/\\'/g, "\\'")
           .replace(/\\"/g, '\\"')
           .replace(/\\&/g, "\\&")
           .replace(/\\r/g, "\\r")
           .replace(/\\t/g, "\\t")
           .replace(/\\b/g, "\\b")
           .replace(/\\f/g, "\\f")
           .replace(/[\u0000-\u0019]+/g,"")
           .replace(/\n/g, "\\n");

      // Remove New Lines
      return JSON.parse(s)
    }

    var drawMap = function() {
      var styles = [{
        "stylers": [
          { "saturation": -100 },
          { "gamma": 1.07 }
        ]}
      ];
      // End Styles
      var mapa = new google.maps.LatLng(5.2445497,-72.4879592);
      var styledMap = new google.maps.StyledMapType(styles,{name: "Styled Map"});
      var mapOptions = {
        zoom: 6,
        center: mapa,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        mapTypeControlOptions: {
          mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'map_style']
        }
      }

      map = new google.maps.Map($("#geolocalizacion_bb")[0], mapOptions);
      map.mapTypes.set('map_style', styledMap);
      map.setMapTypeId('map_style');

      var currentPlace = null;
      var info = $('#placeDetails');
      infowindow = new google.maps.InfoWindow();
    };

    var showMarkers = function(data) {
      markers = [];
      _.each(data, function(d,i){
        var place = d;
        var icon = "http://api.pedbox.co:8850/images/marker1.png";
        if (place.id_catalogo == 3) {
          icon = "http://api.pedbox.co:8850/images/marker2.png";
        } else if (place.id_catalogo == 4) {
          icon = "http://api.pedbox.co:8850/images/marker3.png";
        }
        marker = new google.maps.Marker({
          position: new google.maps.LatLng(place.latitud, place.longitud),
          map: map,
          icon: icon
        });
        markers.push(marker);
        bindInfoWindow(marker, map, place.titulo);
      });
    };

    var clearMarkers = function() {
      for (var i = 0; i < markers.length; i++ ) {
        markers[i].setMap(null);
      }
      markers = [];
    };

    var bindInfoWindow = function(marker, map, description) {
      google.maps.event.addListener(marker, 'click', function() {
        infowindow.setContent(description);
        infowindow.open(map, marker);
      });
    };

    const printContador = (data) => {
      let enfermedades = 0;
      let malezas = 0;
      let plagas = 0;

      for (let i = 0; i < data.length; i++) {
        if (data[i].catalogo == "Malezas") {malezas += 1}
        if (data[i].catalogo == "Enfermedades") {enfermedades += 1}
        if (data[i].catalogo == "Plagas") {plagas += 1}
      }

      $("#enfermedadesCount").text(enfermedades)
      $("#malezasCount").text(malezas)
      $("#plagasCount").text(plagas)
    }

    var datos = '<%- data %>';
    datos = handleJSON(datos)
    console.log(datos)

    $(document).ready(function () {
      drawMap();
      showMarkers(datos.datos);
      printContador(datos.datos);
    })



  </script>

</body>
</html>